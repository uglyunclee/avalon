<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Avalon Online</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap');
        :root { --bg-dark: #121212; --gold: #ffd700; --blue: #29b6f6; --red: #ef5350; --green: #66bb6a; --parchment: #f3e5ab; --wood: #4e342e; }
        
        body { margin: 0; font-family: 'Noto Sans TC', sans-serif; background: #0f0f10 radial-gradient(circle at center, #1f1f2e 0%, #000 100%); color: white; overflow: hidden; height: 100vh; }
        #login { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 200; position: fixed; top:0; width:100%; }
        .login-box { background: rgba(50,50,50,0.4); padding: 40px; border-radius: 20px; border: 1px solid #444; text-align: center; box-shadow: 0 10px 30px black; }
        h1 { font-family: 'Cinzel', serif; font-size: 3.5rem; color: var(--gold); text-shadow: 0 0 15px #ff8c00; margin-bottom: 20px;}
        input { padding: 15px; margin: 10px; border-radius: 8px; border: 1px solid #555; background: #222; color: white; width: 220px; text-align: center; font-size: 1.1rem;}
        button { font-family: 'Cinzel', serif; letter-spacing: 1px; cursor: pointer; transition: 0.2s; }
        .btn-gold { background: linear-gradient(to bottom, #ffd700, #ff8c00); border: none; padding: 12px 30px; font-weight: bold; border-radius: 25px; box-shadow: 0 4px 0 #b86e00; color: #333; font-size: 1.2rem; }
        .btn-gold:active { transform: translateY(4px); box-shadow: 0 0 0 #b86e00; }
        .avatar-select span { font-size: 2.5rem; cursor: pointer; padding: 5px; opacity: 0.5; transition: 0.2s; display: inline-block;}
        .avatar-select span.selected { opacity: 1; transform: scale(1.2); text-shadow: 0 0 15px white; }

        #game { display: none; height: 100vh; position: relative; perspective: 1200px; }
        .top-bar { position: absolute; top: 0; width: 100%; display: flex; justify-content: center; padding-top: 20px; z-index: 10; pointer-events: none;}
        .quest-track { display: flex; gap: 15px; background: rgba(0,0,0,0.7); padding: 12px 30px; border-radius: 50px; border: 1px solid #555; pointer-events: auto;}
        .token { width: 55px; height: 55px; border-radius: 50%; background: #2a2a2a; border: 3px solid #555; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; box-shadow: inset 0 0 10px black; transition: 0.5s; position: relative; }
        .token.active { border-color: var(--gold); box-shadow: 0 0 20px var(--gold); transform: scale(1.1); background: #333;}
        .token.success { background: radial-gradient(circle, #42a5f5, #1565c0); border-color: #90caf9; box-shadow: 0 0 15px var(--blue);}
        .token.fail { background: radial-gradient(circle, #ef5350, #c62828); border-color: #ef9a9a; box-shadow: 0 0 15px var(--red);}
        .vote-track { position: absolute; top: 20px; right: 20px; font-size: 0.9rem; color: #aaa; text-align: right; pointer-events: auto;}
        .vote-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: #333; margin-left: 5px; border: 1px solid #666;}
        .vote-dot.filled { background: var(--red); box-shadow: 0 0 8px var(--red); border-color: #ff8a80;}
        
        .top-left-controls { position: absolute; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 100; pointer-events: auto; }
        .control-btn { background: rgba(50,50,50,0.8); color: white; border: 1px solid #666; padding: 8px 15px; border-radius: 5px; font-size: 0.9rem; width: 120px; text-align: left; }
        .control-btn:hover { background: rgba(80,80,80,0.9); }
        .reset-btn { background: #d32f2f; border-color: #b71c1c; }
        .reset-btn.voted { background: #555; cursor: default; }

        .table-container { position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%) rotateX(25deg); width: 80vh; height: 80vh; transform-style: preserve-3d; }
        .table-surface { width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(#6d4c41, #3e2723); background-image: repeating-radial-gradient(circle at center, #6d4c41 0, #5d4037 2px, #6d4c41 4px); border: 20px solid #2d1e18; box-shadow: 0 30px 60px rgba(0,0,0,0.8), inset 0 0 100px rgba(0,0,0,0.9); position: relative; display: flex; align-items: center; justify-content: center; }
        .table-logo { font-family: 'Cinzel', serif; font-size: 5rem; color: rgba(255,255,255,0.08); user-select: none; transform: rotateX(-25deg); }

        .parchment-panel { background: var(--parchment); color: #3e2723; border: 8px solid #4e342e; border-radius: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.8), inset 0 0 50px rgba(161, 136, 127, 0.5); font-family: 'Noto Sans TC', serif; }
        .settings-panel { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotateX(-25deg); padding: 20px; width: 320px; text-align: center; z-index: 50; }
        .settings-title { font-size: 1.4rem; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #5d4037; padding-bottom: 5px; }
        .settings-group { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 10px; }
        .role-check { display: flex; align-items: center; font-size: 1rem; cursor: pointer; padding: 5px 10px; font-weight: bold; }
        .role-check input { width: auto; margin: 0 5px 0 0; accent-color: #5d4037; }
        .role-check.disabled { opacity: 0.5; cursor: default; }

        .seat { position: absolute; width: 100px; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; transform-origin: center center; transition: 0.5s; transform: translate(-50%, -50%); }
        .seat-inner { transform: rotateX(-25deg); display: flex; flex-direction: column; align-items: center; cursor: pointer; width: 100%;}
        .avatar { width: 65px; height: 65px; border-radius: 50%; background: #444; border: 3px solid #888; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; box-shadow: 0 5px 15px rgba(0,0,0,0.6); position: relative; transition: 0.3s; z-index: 2;}
        .avatar:hover { transform: translateY(-5px); }
        .avatar.leader { border-color: var(--gold); box-shadow: 0 0 25px var(--gold); }
        .avatar.in-team { border-color: var(--blue); box-shadow: 0 0 25px var(--blue); transform: scale(1.15); }
        .avatar.kill-target { border-color: var(--red); box-shadow: 0 0 30px var(--red); animation: pulse 1s infinite; cursor: crosshair; }
        .avatar.ready { border-color: var(--green); box-shadow: 0 0 20px var(--green); }
        .ready-badge { position: absolute; top: -5px; right: -5px; width: 24px; height: 24px; background: var(--green); color: white; border-radius: 50%; font-size: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px black; border: 1px solid #fff; z-index: 3;}
        .vote-badge { position: absolute; bottom: -5px; right: -5px; width: 26px; height: 26px; background: #fff; border-radius: 50%; font-size: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px black; border: 1px solid #333; z-index: 3;}
        .name-tag { background: rgba(0,0,0,0.8); padding: 4px 10px; border-radius: 12px; margin-top: 8px; font-size: 0.85rem; border: 1px solid #555; color: #ddd; max-width: 90px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }
        .status-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -120%) rotateX(-25deg); font-size: 1.8rem; text-shadow: 0 3px 8px black; text-align: center; width: 400px; pointer-events: none; z-index: 20; font-family: 'Cinzel', serif; }
        .action-panel { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 25px; z-index: 50; }
        .action-btn { padding: 15px 40px; font-size: 1.2rem; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.6); transition: 0.2s; font-family: 'Cinzel', serif; text-transform: uppercase; }
        .btn-approve { background: linear-gradient(to bottom, #66bb6a, #43a047); color: white; border: 2px solid #2e7d32; }
        .btn-reject { background: linear-gradient(to bottom, #ef5350, #e53935); color: white; border: 2px solid #c62828; }
        .btn-ready { background: linear-gradient(to bottom, #7e57c2, #5e35b1); color: white; border: 2px solid #4527a0; }
        .btn-ready.is-ready { background: linear-gradient(to bottom, #444, #333); color: #aaa; border: 2px solid #222; }
        .action-btn:hover { transform: translateY(-3px) scale(1.05); filter: brightness(1.1); }
        .game-log { position: absolute; bottom: 20px; left: 20px; width: 320px; height: 220px; background: rgba(20, 20, 20, 0.85); border: 1px solid #555; border-radius: 12px; overflow-y: auto; padding: 15px; font-size: 0.9rem; z-index: 40; font-family: monospace; backdrop-filter: blur(5px); box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .game-log div { margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.08); line-height: 1.4; }
        
        .bottom-right-container { position: absolute; bottom: 20px; right: 20px; display: flex; align-items: flex-end; gap: 10px; z-index: 50; }
        .notepad { width: 200px; height: 220px; background: var(--parchment); color: #3e2723; border: 4px solid #4e342e; border-radius: 5px; padding: 10px; display: flex; flex-direction: column; transition: 0.3s; box-shadow: 0 5px 15px black;}
        .notepad textarea { width: 100%; height: 100%; background: transparent; border: none; color: #3e2723; resize: none; font-family: 'Noto Sans TC', monospace; outline: none; font-size: 0.9rem; font-weight: bold; }
        .notepad-title { font-size: 0.8rem; color: #5d4037; margin-bottom: 5px; border-bottom: 1px solid #a1887f; font-weight: bold;}
        
        .card-container { width: 150px; height: 220px; perspective: 1000px; cursor: pointer; position: relative; }
        .player-name-plate { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: var(--gold); color: #000; padding: 2px 10px; border-radius: 4px; font-weight: bold; font-size: 0.9rem; white-space: nowrap; box-shadow: 0 2px 5px black; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .card-container.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; border: 2px solid #6d4c41; box-shadow: 0 10px 25px black; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card-front { background: #2d1e18 repeating-linear-gradient(45deg, #3e2723 0, #3e2723 10px, #2d1e18 10px, #2d1e18 20px); color: #6d4c41; font-size: 4rem; text-shadow: 1px 1px 0 rgba(255,255,255,0.1); }
        .card-back { background: linear-gradient(135deg, #fffde7, #fff9c4); color: #333; transform: rotateY(180deg); border: 4px solid var(--gold); }
        .card-back.bad { background: linear-gradient(135deg, #ffcdd2, #e57373); border-color: var(--red); }
        .role-title { font-size: 1.6rem; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #555; width: 80%; }
        .role-desc { font-size: 0.85rem; padding: 0 10px; line-height: 1.5; color: #444; font-weight: bold;}

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); z-index: 200; display: flex; justify-content: center; align-items: center; }
        .modal-history { width: 80%; max-width: 600px; max-height: 80vh; overflow-y: auto; padding: 20px; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .history-table th, .history-table td { border: 1px solid #8d6e63; padding: 8px; text-align: center; font-size: 0.9rem; }
        .history-table th { background: #5d4037; color: var(--parchment); }
        .history-table tr:nth-child(even) { background: rgba(141, 110, 99, 0.1); }
        .vote-yes { color: green; font-weight: bold; }
        .vote-no { color: red; font-weight: bold; }
        .close-btn { margin-top: 15px; background: #5d4037; color: white; border: none; padding: 8px 20px; cursor: pointer; border-radius: 5px; }

        .toast { position: fixed; top: 15%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.95); padding: 15px 40px; border-radius: 50px; border: 2px solid var(--gold); color: var(--gold); font-size: 1.4rem; animation: fadeInOut 3s forwards; z-index: 300; pointer-events: none; white-space: nowrap; }
        @keyframes fadeInOut { 0% {opacity:0; transform:translate(-50%, -20px);} 10% {opacity:1; transform:translate(-50%, 0);} 90% {opacity:1;} 100% {opacity:0;} }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.0/socket.io.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
<div id="app">
    <div id="login" v-if="!joined">
        <div class="login-box">
            <h1>AVALON</h1>
            <input v-model="name" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±" @keyup.enter="join"><br>
            <input v-model="roomId" placeholder="æˆ¿é–“è™Ÿç¢¼ (ä¾‹: 101)"><br>
            <p style="margin: 15px 0; color: #ccc;">é¸æ“‡é ­åƒ</p>
            <div class="avatar-select">
                <span v-for="a in avatars" :class="{selected: avatar===a}" @click="avatar=a">{{a}}</span>
            </div>
            <button class="btn-gold" @click="join">é€²å…¥åœ“æ¡Œ</button>
            <p v-if="hasToken" style="font-size: 0.8rem; color: #66ff66; margin-top: 10px;">* åµæ¸¬åˆ°èˆŠç´€éŒ„ï¼Œå°‡è‡ªå‹•é‡é€£</p>
        </div>
    </div>
    <div id="game" :style="{display: joined ? 'block' : 'none'}">
        <div class="top-left-controls">
            <button class="control-btn" @click="showHistory = true">ğŸ“œ æˆ°æ³ç´€éŒ„</button>
            <button class="control-btn reset-btn" :class="{voted: hasResetVoted}" @click="requestReset">
                {{ hasResetVoted ? 'å·²è«‹æ±‚é‡ç½®' : 'âš  è«‹æ±‚é‡ç½®' }}
            </button>
            <div v-if="resetVotesCount > 0" style="color:#aaa; font-size:0.8rem; text-align:center;">
                é‡ç½®: {{ resetVotesCount }} / {{ Math.floor(players.length/2) + 1 }}
            </div>
        </div>

        <div class="top-bar">
            <div class="quest-track">
                <div v-for="(res, i) in questResults" :key="i" class="token" :class="{success: res===true, fail: res===false, active: i===questIdx}">
                    <span v-if="res===true">ğŸ›¡ï¸</span><span v-if="res===false">ğŸ”¥</span><span v-if="res===null" style="color: #666;">{{i+1}}</span>
                </div>
            </div>
            <div class="vote-track">ææ¡ˆå¤±æ•—æ¬¡æ•¸<br><span v-for="n in 5" class="vote-dot" :class="{filled: n <= voteTrack}"></span></div>
        </div>
        <div class="table-container">
            <div class="table-surface">
                <div class="table-logo" v-if="state !== 'LOBBY'">AVALON</div>
                
                <div class="settings-panel parchment-panel" v-if="state === 'LOBBY'">
                    <div class="settings-title">éŠæˆ²è¨­å®š (æˆ¿ä¸»å¯èª¿)</div>
                    <div class="settings-group">
                        <label class="role-check" :class="{disabled: !isMeFirst}">
                            <input type="checkbox" v-model="localSettings.merlin" :disabled="!isMeFirst" @change="updateSettings"> æ¢…æ—
                        </label>
                        <label class="role-check" :class="{disabled: !isMeFirst}">
                            <input type="checkbox" v-model="localSettings.percival" :disabled="!isMeFirst" @change="updateSettings"> æ´¾è¥¿ç¶­çˆ¾
                        </label>
                        <label class="role-check" :class="{disabled: !isMeFirst}">
                            <input type="checkbox" v-model="localSettings.assassin" :disabled="!isMeFirst" @change="updateSettings"> åˆºå®¢
                        </label>
                        <label class="role-check" :class="{disabled: !isMeFirst}">
                            <input type="checkbox" v-model="localSettings.morgana" :disabled="!isMeFirst" @change="updateSettings"> è«ç”˜å¨œ
                        </label>
                        <label class="role-check" :class="{disabled: !isMeFirst}">
                            <input type="checkbox" v-model="localSettings.mordred" :disabled="!isMeFirst" @change="updateSettings"> è«å¾·é›·å¾·
                        </label>
                        <label class="role-check" :class="{disabled: !isMeFirst}">
                            <input type="checkbox" v-model="localSettings.oberon" :disabled="!isMeFirst" @change="updateSettings"> å¥§ä¼¯å€«
                        </label>
                    </div>
                    <div class="balance-info">ç•¶å‰: {{ players.length }} äºº | å…¨å“¡æº–å‚™å¾Œè‡ªå‹•é–‹å§‹</div>
                    <div style="margin-top:15px; font-size:1.2rem; font-weight:bold;">
                        æº–å‚™ç‹€æ…‹: {{readyCount}} / {{players.length}}
                    </div>
                </div>

                <div class="status-msg" v-if="state !== 'LOBBY'">
                    <div v-if="state === 'TEAM_SELECTION'"><span style="color:var(--gold)">{{getLeaderName()}}</span><br>æ­£åœ¨æŒ‘é¸éšŠå“¡<div style="font-size:1rem; margin-top:5px; color:#aaa; font-family:sans-serif">(éœ€é¸ {{teamSizeNeeded}} äºº)</div></div>
                    <div v-if="state === 'TEAM_VOTING'">å…¨å“¡æŠ•ç¥¨ä¸­...</div>
                    <div v-if="state === 'MISSION'">éšŠä¼åŸ·è¡Œä»»å‹™ä¸­...</div>
                    <div v-if="state === 'ASSASSINATION'" style="color:var(--red);">åˆºæ®ºç’°ç¯€ï¼<br><span style="font-size: 1rem">åˆºå®¢è«‹é»æ“Šé ­åƒ</span></div>
                    <div v-if="state === 'GAME_OVER'" style="color:var(--gold); font-size:2.5rem;">éŠæˆ²çµæŸ</div>
                </div>
                <div v-for="(p, index) in players" :key="p.token" class="seat" :class="{disconnected: !p.is_connected}" :style="getSeatStyle(index, players.length)">
                    <div class="seat-inner">
                        <div class="avatar" :class="{leader: p.is_leader, 'in-team': p.in_team, 'kill-target': isAssassinationPhase && isMeAssassin && p.token !== myToken, 'ready': p.is_ready}" @click="handleAvatarClick(p)">
                            {{ p.avatar }}
                            <div class="vote-badge" v-if="state === 'TEAM_VOTING' && p.has_voted">ğŸ“©</div>
                            <div class="vote-badge" v-if="state === 'MISSION' && p.in_team && p.has_voted">âš”ï¸</div>
                            <div class="ready-badge" v-if="state === 'LOBBY' && p.is_ready">âœ”</div>
                        </div>
                        <div class="name-tag">{{ p.name }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="action-panel">
            <div v-if="state === 'LOBBY'">
                <button class="action-btn btn-ready" :class="{'is-ready': isMeReady}" @click="toggleReady">
                    {{ isMeReady ? 'å–æ¶ˆæº–å‚™' : 'æº–å‚™' }}
                </button>
            </div>
            <div v-if="state === 'TEAM_SELECTION' && isMeLeader">
                <button class="action-btn btn-gold" :disabled="mySelectedTeam.length !== teamSizeNeeded" @click="submitTeam" :style="{opacity: mySelectedTeam.length !== teamSizeNeeded ? 0.5 : 1}">ç¢ºèªææ¡ˆ ({{mySelectedTeam.length}}/{{teamSizeNeeded}})</button>
            </div>
            <div v-if="state === 'TEAM_VOTING' && !iHaveVoted">
                <button class="action-btn btn-approve" @click="voteTeam(true)">â­• è´Šæˆ</button>
                <button class="action-btn btn-reject" @click="voteTeam(false)">âŒ åå°</button>
            </div>
            <div v-if="state === 'MISSION' && amIInTeam && !iHaveVoted">
                <button class="action-btn btn-approve" @click="voteMission(true)">ğŸ›¡ï¸ æˆåŠŸ</button>
                <button class="action-btn btn-reject" @click="voteMission(false)">ğŸ”¥ å¤±æ•—</button>
            </div>
        </div>
        <div class="game-log" ref="logRef"><div v-for="(log, i) in logs" :key="i" :style="{color: log.color}"><span style="opacity:0.4; font-size:0.8em; margin-right:5px;">[{{log.time}}]</span><span v-html="log.msg"></span></div></div>
        
        <div class="bottom-right-container">
            <div class="notepad">
                <div class="notepad-title">ğŸ“ éš¨èº«ç­†è¨˜</div>
                <textarea v-model="notepadContent" placeholder="åœ¨æ­¤ç´€éŒ„æ¨ç†..."></textarea>
            </div>
            <div class="card-container" :class="{flipped: cardFlipped}" @click="cardFlipped = !cardFlipped" v-if="myRole">
                <div class="player-name-plate">{{ name }}</div>
                <div class="card-inner">
                    <div class="card-front">?</div>
                    <div class="card-back" :class="{bad: isBadRole(myRole)}">
                        <div class="role-title">{{ myRole }}</div>
                        <div class="role-desc">
                            <div v-if="teammates.length"><span style="display:block; margin-bottom:5px; opacity:0.6">ä½ çš„è¦–é‡</span>{{ teammates.join(', ') }}</div>
                            <div v-else>
                                <span v-if="myRole === 'æ¢…æ—'" style="opacity:0.6; color:#ef5350">ç„¡å¯è¦‹å£äºº (å¯èƒ½åªæœ‰è«å¾·é›·å¾·)</span>
                                <span v-else style="opacity:0.6">ç„¡ç‰¹æ®Šè¦–é‡</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal-overlay" v-if="showHistory">
            <div class="parchment-panel modal-history">
                <h2 style="text-align:center; border-bottom:2px solid #5d4037; padding-bottom:10px;">ğŸ“œ æˆ°æ³ç´€éŒ„è¡¨</h2>
                <table class="history-table" v-if="gameHistory.length > 0">
                    <thead><tr><th>å±€æ•¸</th><th>éšŠé•·</th><th>éšŠä¼</th><th>æŠ•ç¥¨çµæœ</th><th>ä»»å‹™</th></tr></thead>
                    <tbody>
                        <tr v-for="(entry, i) in gameHistory" :key="i">
                            <td>R{{ entry.quest }}</td>
                            <td>{{ entry.leader }}</td>
                            <td>{{ entry.team.join(', ') }}</td>
                            <td>
                                <div style="font-size:0.8rem; margin-bottom:5px;">
                                    <span v-for="(vote, pName) in entry.votes" :key="pName" :class="vote ? 'vote-yes' : 'vote-no'">
                                        {{ pName }}{{ vote ? 'â­•' : 'âŒ' }} 
                                    </span>
                                </div>
                                <strong>{{ entry.result }}</strong>
                            </td>
                            <td>{{ entry.mission_result || '-' }}<br><span v-if="entry.fail_count > 0" style="color:red; font-size:0.8rem;">({{ entry.fail_count }}é»‘)</span></td>
                        </tr>
                    </tbody>
                </table>
                <div v-else style="text-align:center; padding:20px; color:#666;">å°šç„¡ç´€éŒ„</div>
                <div style="text-align:center;"><button class="close-btn" @click="showHistory = false">é—œé–‰</button></div>
            </div>
        </div>

        <div v-if="toastMsg" class="toast">{{ toastMsg }}</div>
    </div>
</div>
<script>
    const socket = io();
    const { createApp, ref, computed, nextTick, watch, reactive } = Vue;
    createApp({
        setup() {
            const name = ref(''); const roomId = ref('101'); const avatar = ref('ğŸ¦');
            const avatars = ['ğŸ¦','ğŸ¦Š','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ·','ğŸ¸','ğŸµ', 'ğŸ§™â€â™‚ï¸', 'ğŸ§â€â™€ï¸'];
            const joined = ref(false); const myToken = ref(localStorage.getItem('avalon_token') || '');
            const state = ref('LOBBY'); const players = ref([]); const questResults = ref([null, null, null, null, null]);
            const questIdx = ref(0); const teamSizeNeeded = ref(0); const voteTrack = ref(0); const logs = ref([]);
            const myRole = ref(''); const teammates = ref([]); const cardFlipped = ref(false);
            const mySelectedTeam = ref([]); const toastMsg = ref(''); const logRef = ref(null);
            const localSettings = reactive({ merlin: true, percival: true, assassin: true, morgana: true, mordred: false, oberon: false });
            const gameHistory = ref([]); 
            const showHistory = ref(false);

            const notepadContent = ref(localStorage.getItem('avalon_notes') || '');
            watch(notepadContent, (newVal) => { localStorage.setItem('avalon_notes', newVal); });

            socket.on('join_success', (data) => { myToken.value = data.token; localStorage.setItem('avalon_token', data.token); joined.value = true; });
            socket.on('new_log', (log) => { logs.value.push(log); nextTick(() => { if(logRef.value) logRef.value.scrollTop = logRef.value.scrollHeight; }); });
            socket.on('mission_effect', (data) => { if(!data.success) { document.body.classList.add('shake'); setTimeout(() => document.body.classList.remove('shake'), 500); } });
            socket.on('update_state', (data) => {
                state.value = data.state; players.value = data.players; questResults.value = data.quest_results;
                questIdx.value = data.quest_idx; teamSizeNeeded.value = data.team_size_needed; voteTrack.value = data.vote_track;
                if(data.logs) logs.value = data.logs;
                if(data.game_history) gameHistory.value = data.game_history;
                if(data.state !== 'TEAM_SELECTION') mySelectedTeam.value = [];
                if (data.settings && !isMeFirst.value) Object.assign(localSettings, data.settings);
            });
            socket.on('role_info', (data) => { myRole.value = data.role; teammates.value = data.teammates; cardFlipped.value = true; setTimeout(() => cardFlipped.value = false, 4000); });
            socket.on('vote_finished', (data) => showToast(data.pass ? "æŠ•ç¥¨é€šéï¼" : "æŠ•ç¥¨è¢«å¦æ±ºï¼"));
            socket.on('game_over', (data) => showToast("éŠæˆ²çµæŸ: " + data.winner));

            const isMeLeader = computed(() => { const me = players.value.find(p => p.token === myToken.value); return me && me.is_leader; });
            const isMeFirst = computed(() => players.value.length > 0 && players.value[0].token === myToken.value);
            const amIInTeam = computed(() => { const me = players.value.find(p => p.token === myToken.value); return me && me.in_team; });
            const iHaveVoted = computed(() => { const me = players.value.find(p => p.token === myToken.value); return me && me.has_voted; });
            const hasToken = computed(() => !!myToken.value);
            const isAssassinationPhase = computed(() => state.value === 'ASSASSINATION');
            const isMeAssassin = computed(() => myRole.value === 'åˆºå®¢');
            const hasResetVoted = computed(() => { const me = players.value.find(p => p.token === myToken.value); return me && me.has_reset_voted; });
            const resetVotesCount = computed(() => players.value.filter(p => p.has_reset_voted).length);
            const isMeReady = computed(() => { const me = players.value.find(p => p.token === myToken.value); return me && me.is_ready; });
            const readyCount = computed(() => players.value.filter(p => p.is_ready).length);

            const join = () => { if(!name.value) return alert("è«‹è¼¸å…¥ä½ çš„å¤§å"); socket.emit('join_room', { name: name.value, room_id: roomId.value, avatar: avatar.value, token: myToken.value }); };
            const toggleReady = () => socket.emit('toggle_ready', roomId.value);
            const requestReset = () => { if(!hasResetVoted.value) socket.emit('request_reset', roomId.value); };
            const updateSettings = () => { if(isMeFirst.value) socket.emit('update_settings', { room_id: roomId.value, settings: localSettings }); };
            const toggleTeam = (token) => {
                if(state.value !== 'TEAM_SELECTION' || !isMeLeader.value) return;
                if(mySelectedTeam.value.includes(token)) mySelectedTeam.value = mySelectedTeam.value.filter(t => t !== token);
                else if(mySelectedTeam.value.length < teamSizeNeeded.value) mySelectedTeam.value.push(token);
                players.value.forEach(p => p.in_team = mySelectedTeam.value.includes(p.token));
            };
            const handleAvatarClick = (player) => {
                if (state.value === 'TEAM_SELECTION') toggleTeam(player.token);
                else if (state.value === 'ASSASSINATION' && myRole.value === 'åˆºå®¢' && player.token !== myToken.value) {
                    if(confirm(`ç¢ºå®šè¦åˆºæ®º ${player.name} å—ï¼Ÿ`)) socket.emit('assassinate', { room_id: roomId.value, target_token: player.token });
                }
            };
            const submitTeam = () => socket.emit('select_team', {room_id: roomId.value, team: mySelectedTeam.value});
            const voteTeam = (v) => socket.emit('vote_team', {room_id: roomId.value, vote: v});
            const voteMission = (v) => socket.emit('vote_mission', {room_id: roomId.value, result: v});
            const showToast = (msg) => { toastMsg.value = msg; setTimeout(() => toastMsg.value = '', 3000); };
            const isBadRole = (r) => ['åˆºå®¢','è«ç”˜å¨œ','å£äºº','è«å¾·é›·å¾·'].includes(r);
            const getLeaderName = () => players.value.find(p => p.is_leader)?.name || '';
            const getSeatStyle = (index, total) => {
                const myIndex = players.value.findIndex(p => p.token === myToken.value);
                let relativeIndex = index;
                if (myIndex !== -1) relativeIndex = (index - myIndex + total) % total;
                const angle = (relativeIndex / total) * 2 * Math.PI + Math.PI/2;
                const radius = 43; const x = Math.cos(angle) * radius + 50; const y = Math.sin(angle) * radius + 50; return { left: x + '%', top: y + '%' };
            };

            return { 
                name, roomId, avatar, avatars, joined, hasToken, myToken, state, players, 
                questResults, questIdx, teamSizeNeeded, voteTrack, logs, myRole, teammates, cardFlipped, 
                notepadContent, hasResetVoted, resetVotesCount, isMeReady, readyCount, isMeFirst, localSettings,
                gameHistory, showHistory,
                join, toggleReady, requestReset, updateSettings, handleAvatarClick, submitTeam, voteTeam, voteMission, 
                isMeLeader, mySelectedTeam, amIInTeam, iHaveVoted, isBadRole, getLeaderName, getSeatStyle, 
                logRef, toastMsg, isAssassinationPhase, isMeAssassin 
            };
        }
    }).mount('#app');
</script>
</body>
</html>
